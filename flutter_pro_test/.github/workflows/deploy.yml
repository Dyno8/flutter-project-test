name: ðŸš€ CareNow MVP - Deployment Pipeline

on:
  workflow_run:
    workflows: ["ðŸ—ï¸ CareNow MVP - Multi-Platform Build"]
    types: [completed]
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'staging'
        type: choice
        options:
        - development
        - staging
        - production
      platforms:
        description: 'Platforms to deploy'
        required: true
        default: 'web'
        type: choice
        options:
        - web
        - android
        - ios
        - all
      skip_approval:
        description: 'Skip manual approval for production'
        required: false
        default: false
        type: boolean

env:
  NODE_VERSION: '18'

jobs:
  # Job 1: Deployment Setup
  setup:
    name: ðŸ”§ Deployment Setup
    runs-on: ubuntu-latest
    if: github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch'
    outputs:
      deploy-environment: ${{ steps.environment.outputs.environment }}
      deploy-platforms: ${{ steps.platforms.outputs.platforms }}
      requires-approval: ${{ steps.approval.outputs.required }}
      version: ${{ steps.version.outputs.version }}
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ðŸŒ Determine Environment
      id: environment
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          ENV="${{ github.event.inputs.environment }}"
        elif [ "${{ github.ref }}" = "refs/heads/main" ]; then
          ENV="production"
        elif [ "${{ github.ref }}" = "refs/heads/develop" ]; then
          ENV="staging"
        else
          ENV="development"
        fi
        
        echo "environment=$ENV" >> $GITHUB_OUTPUT
        echo "Deployment environment: $ENV"
    
    - name: ðŸŽ¯ Determine Platforms
      id: platforms
      run: |
        if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
          PLATFORMS="${{ github.event.inputs.platforms }}"
        else
          PLATFORMS="web"
        fi
        
        echo "platforms=$PLATFORMS" >> $GITHUB_OUTPUT
        echo "Deployment platforms: $PLATFORMS"
    
    - name: âœ‹ Check Approval Requirements
      id: approval
      run: |
        REQUIRED="false"
        
        if [ "${{ steps.environment.outputs.environment }}" = "production" ]; then
          if [ "${{ github.event.inputs.skip_approval }}" != "true" ]; then
            REQUIRED="true"
          fi
        fi
        
        echo "required=$REQUIRED" >> $GITHUB_OUTPUT
        echo "Manual approval required: $REQUIRED"
    
    - name: ðŸ“Š Get Version
      id: version
      run: |
        VERSION=$(grep -E "^version:" flutter_pro_test/pubspec.yaml | cut -d' ' -f2 | cut -d'+' -f1)
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "App version: $VERSION"

  # Job 2: Production Approval
  approval:
    name: âœ‹ Production Approval
    runs-on: ubuntu-latest
    needs: setup
    if: needs.setup.outputs.requires-approval == 'true'
    environment:
      name: production-approval
      url: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}
    
    steps:
    - name: âœ‹ Awaiting Approval
      run: |
        echo "ðŸ”’ Production deployment requires manual approval"
        echo "Environment: ${{ needs.setup.outputs.deploy-environment }}"
        echo "Platforms: ${{ needs.setup.outputs.deploy-platforms }}"
        echo "Version: ${{ needs.setup.outputs.version }}"

  # Job 3: Security Pre-Deployment Check
  security-check:
    name: ðŸ” Security Pre-Deployment
    runs-on: ubuntu-latest
    needs: [setup, approval]
    if: always() && (needs.approval.result == 'success' || needs.setup.outputs.requires-approval == 'false')
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ðŸ” Final Security Scan
      run: |
        echo "ðŸ” Running final security scan before deployment..."
        
        # Check for any last-minute security issues
        if grep -r "TODO.*security\|FIXME.*security\|XXX.*security" flutter_pro_test/lib/ --ignore-case; then
          echo "âš ï¸ Security-related TODOs found - review before deployment"
        fi
        
        # Verify environment configuration
        if [ ! -f "flutter_pro_test/lib/core/config/environment_config.dart" ]; then
          echo "âŒ Environment configuration missing"
          exit 1
        fi
        
        echo "âœ… Security pre-deployment check passed"
    
    - name: ðŸ”’ Validate Secrets
      env:
        FIREBASE_WEB_API_KEY: ${{ secrets.FIREBASE_WEB_API_KEY }}
        FIREBASE_ANDROID_API_KEY: ${{ secrets.FIREBASE_ANDROID_API_KEY }}
        FIREBASE_IOS_API_KEY: ${{ secrets.FIREBASE_IOS_API_KEY }}
      run: |
        echo "ðŸ”’ Validating deployment secrets..."
        
        MISSING_SECRETS=()
        
        if [ -z "$FIREBASE_WEB_API_KEY" ]; then
          MISSING_SECRETS+=("FIREBASE_WEB_API_KEY")
        fi
        
        if [ -z "$FIREBASE_ANDROID_API_KEY" ]; then
          MISSING_SECRETS+=("FIREBASE_ANDROID_API_KEY")
        fi
        
        if [ -z "$FIREBASE_IOS_API_KEY" ]; then
          MISSING_SECRETS+=("FIREBASE_IOS_API_KEY")
        fi
        
        if [ ${#MISSING_SECRETS[@]} -gt 0 ]; then
          echo "âŒ Missing required secrets: ${MISSING_SECRETS[*]}"
          echo "âš ï¸ Deployment may fail without proper configuration"
        else
          echo "âœ… All required secrets are configured"
        fi

  # Job 4: Web Deployment
  deploy-web:
    name: ðŸŒ Deploy Web
    runs-on: ubuntu-latest
    needs: [setup, security-check]
    if: contains(needs.setup.outputs.deploy-platforms, 'web') || contains(needs.setup.outputs.deploy-platforms, 'all')
    environment:
      name: ${{ needs.setup.outputs.deploy-environment }}-web
      url: ${{ steps.deploy.outputs.url }}
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ðŸ“¦ Download Web Build
      uses: actions/download-artifact@v4
      with:
        name: web-build-${{ needs.setup.outputs.deploy-environment }}
        path: build/web/
    
    - name: ðŸŒ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
    
    - name: ðŸ”¥ Setup Firebase CLI
      run: |
        npm install -g firebase-tools
        echo "âœ… Firebase CLI installed"
    
    - name: ðŸš€ Deploy to Firebase Hosting
      id: deploy
      env:
        FIREBASE_TOKEN: ${{ secrets.FIREBASE_TOKEN }}
        FIREBASE_PROJECT_ID: ${{ secrets.FIREBASE_PROJECT_ID }}
      run: |
        echo "ðŸš€ Deploying to Firebase Hosting..."
        
        # Configure Firebase project
        firebase use $FIREBASE_PROJECT_ID --token $FIREBASE_TOKEN
        
        # Deploy based on environment
        if [ "${{ needs.setup.outputs.deploy-environment }}" = "production" ]; then
          firebase deploy --only hosting:production --token $FIREBASE_TOKEN
          URL="https://$FIREBASE_PROJECT_ID.web.app"
        elif [ "${{ needs.setup.outputs.deploy-environment }}" = "staging" ]; then
          firebase deploy --only hosting:staging --token $FIREBASE_TOKEN
          URL="https://staging---$FIREBASE_PROJECT_ID.web.app"
        else
          firebase deploy --only hosting:dev --token $FIREBASE_TOKEN
          URL="https://dev---$FIREBASE_PROJECT_ID.web.app"
        fi
        
        echo "url=$URL" >> $GITHUB_OUTPUT
        echo "âœ… Web deployment completed: $URL"
    
    - name: ðŸ” Post-Deployment Verification
      run: |
        echo "ðŸ” Verifying web deployment..."
        
        # Wait for deployment to be available
        sleep 30
        
        # Check if the site is accessible
        if curl -f -s "${{ steps.deploy.outputs.url }}" > /dev/null; then
          echo "âœ… Web application is accessible"
        else
          echo "âš ï¸ Web application may not be fully deployed yet"
        fi
    
    - name: ðŸ“Š Web Deployment Report
      run: |
        echo "## ðŸŒ Web Deployment Results" >> $GITHUB_STEP_SUMMARY
        echo "- Environment: ${{ needs.setup.outputs.deploy-environment }}" >> $GITHUB_STEP_SUMMARY
        echo "- URL: ${{ steps.deploy.outputs.url }}" >> $GITHUB_STEP_SUMMARY
        echo "- Version: ${{ needs.setup.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        echo "- Status: âœ… DEPLOYED" >> $GITHUB_STEP_SUMMARY

  # Job 5: Android Deployment
  deploy-android:
    name: ðŸ¤– Deploy Android
    runs-on: ubuntu-latest
    needs: [setup, security-check]
    if: contains(needs.setup.outputs.deploy-platforms, 'android') || contains(needs.setup.outputs.deploy-platforms, 'all')
    environment:
      name: ${{ needs.setup.outputs.deploy-environment }}-android
    
    steps:
    - name: ðŸ“¥ Checkout Repository
      uses: actions/checkout@v4
    
    - name: ðŸ“¦ Download Android Build
      uses: actions/download-artifact@v4
      with:
        name: android-build-${{ needs.setup.outputs.deploy-environment }}
        path: build/android/
    
    - name: ðŸ¤– Deploy to Google Play (Production)
      if: needs.setup.outputs.deploy-environment == 'production'
      env:
        GOOGLE_PLAY_SERVICE_ACCOUNT: ${{ secrets.GOOGLE_PLAY_SERVICE_ACCOUNT }}
      run: |
        echo "ðŸ¤– Deploying to Google Play Store..."
        
        if [ -n "$GOOGLE_PLAY_SERVICE_ACCOUNT" ]; then
          # Setup Google Play deployment
          echo "$GOOGLE_PLAY_SERVICE_ACCOUNT" > service-account.json
          
          # Deploy App Bundle to Play Store
          if [ -f "build/android/app-release.aab" ]; then
            echo "ðŸ“¦ Uploading App Bundle to Play Store..."
            # Add Google Play deployment logic here
            echo "âœ… App Bundle uploaded to Play Store"
          else
            echo "âš ï¸ No App Bundle found for Play Store deployment"
          fi
        else
          echo "âš ï¸ Google Play service account not configured"
        fi
    
    - name: ðŸ“Š Android Deployment Report
      run: |
        echo "## ðŸ¤– Android Deployment Results" >> $GITHUB_STEP_SUMMARY
        echo "- Environment: ${{ needs.setup.outputs.deploy-environment }}" >> $GITHUB_STEP_SUMMARY
        echo "- Version: ${{ needs.setup.outputs.version }}" >> $GITHUB_STEP_SUMMARY
        
        if [ "${{ needs.setup.outputs.deploy-environment }}" = "production" ]; then
          echo "- Target: Google Play Store" >> $GITHUB_STEP_SUMMARY
        else
          echo "- Target: Internal Distribution" >> $GITHUB_STEP_SUMMARY
        fi
